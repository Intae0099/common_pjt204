from langchain.prompts import PromptTemplate

def get_cot_prompt() -> PromptTemplate:
    """CoT(Chain-of-Thought) 프롬프트를 생성합니다."""
    template = """
        다음 4단계 사고 과정을 따라 사용자 질문에 답변하세요.
        반드시 아래 규칙을 지키십시오.

        ### 규칙
        1. 사고 과정을 내부적으로 수행하되, 출력은 오직 JSON이어야 합니다. (코드블록·주석 금지)
        2. JSON 스키마는 예시와 키·중괄호·배열 순서까지 동일해야 합니다.
        3. 값은 한국어로 작성합니다. (숫자·부호 제외)
        4. 필요 없거나 파악되지 않는 값은 null로 두지 말고 적절히 추론해 채웁니다.
        5. 숫자형 값은 따옴표 없이 기입합니다. (예: 0.84)
        6. issues는 최소 1개 이상, 명사형 문구로 작성합니다.

        ### 사고 과정
        * 사건 무게 판단  
        제공된 판례와 사례를 검토하여 ‘가벼운 사건’인지 ‘무거운 사건’인지 분류하고, 분류 결과에 따라 조언의 강도를 결정하라.

        * 쟁점 파악  
        질문을 분석해 핵심 부분을 요약하고, 주요 법률 쟁점을 명시하라.

        * 사실·법리 분석  
        중요 사실과 적용 법리를 연결하여, 전문가 관점의 논리적 설명을 포함하라.

        * 결론 제시  
        위 분석을 종합해 최종 결론과 근거를 한눈에 제시하라. 반드시 구체적 판례를 인용하여 근거를 명시하고, "~하는 것이 예상된다" 또는 "~하는 것이 바람직하다" 등의 추측성 표현을 사용하라.

        ### 판례 선택 및 인용 규칙 (MULTI-CASE REQUIRED)
        - case_docs 전체를 내부적으로 스코어링(사실·법리 유사도 기준)하여 **상위 3개**를 선정하라.
        - **opinion**에는 **서로 다른 최소 2개의 판례**를 **사건번호와 함께 병기**하여 **비교·종합 인용**하라.  
          (예: "A사건(사건번호: 2020고단0000) ... ; B사건(사건번호: 2022고단0000) ... ~한 것으로 예상된다.")
        - **첫 번째 항목만 단독 인용 금지**. (case_docs[0]만 쓰지 말 것)
        - **references.cases**에는 선정된 상위 3개를 **중요도 순**으로, **중복 없이** 기재하라.
        - **opinion**에서 인용한 판례 중 최소 2개는 **references.cases**와 **동일한 케이스**여야 한다.

        ### chunk_summary 작성 규칙 (LOSSLESS EVIDENCE EMBED)
        - **스키마를 변경하지 말고**, `chunk_summary` **문자열 내부에** 다음 4요소를 순서대로 포함하라:
          1) **핵심요지**: 한 문장 요약
          2) **근거문장**: 청크에서 직접 인용 1~2개(각 20단어 이하, 따옴표로 표시)
          3) **매칭근거**: 키워드/법리/사실 포인트(쉼표 구분)
          4) **위치힌트**: 가능한 경우 문단/줄/페이지/문장 인덱스 등(없으면 N/A)
        - 포맷(엄수):  
          `핵심요지: … | 근거문장: "…"; "…" | 매칭근거: … `
        - **과도한 요약 금지**: 핵심 개념·요건·행위태양·인과관계는 반드시 남겨라.
        - **개인정보/계좌번호 등 민감정보는 마스킹**(예: 010-****-****, 계좌번호 일부 ****).

        --- 입력 ---
        사용자 질문:
        {user_query}

        관련 판례·법령 정보:
        {case_docs}

        [태그 목록]
        {tag_list}
        --- 입력 끝 ---

        ### 출력 예시 (*구조만 참고, 값은 변경*)
        {{
        "data": {{
            "report": {{
            "issues": ["계약 체결 시 기망 여부", "피해 금액 산정"],
            "opinion": "○○사건(사건번호: 2020다12345)과 △△사건(사건번호: 2019도54321)에서 법원은 '기망행위로 인한 재산적 처분'을 폭넓게 인정했다고 판시한 바, 본 사건 역시 유사한 법리가 적용될 가능성이 높아 피해 회복 및 형사책임 인정이 가능한 것으로 예상된다.",
            "sentencePrediction": "[사전 기망 정황과 반복성, 피해자 다수]로 형사상 사기죄 성립 및 집행유예 이상 처벌 가능성이 있는 것으로 보인다.",
            "confidence": 0.84,
            "references": {{
                "cases": [
                {{ "id": 93810,
                   "title": "소유권이전등기말소",
                   "decision_date": "1978-01-01",
                   "category": "일반 행정",
                   "chunk_summary": "핵심요지: 재산적 처분 유발 기망 인정 범위 정리 | 근거문장: \"기망으로 인한 처분행위\" }},
                {{ "id": 12345,
                   "title": "사기",
                   "decision_date": "2021-05-03",
                   "category": "형사",
                   "chunk_summary": "핵심요지: 선입금 편취형 온라인 사기의 구성요건 해당성 | 근거문장: \"물품을 보낼 의사나 능력이 없었다\" }},
                {{ "id": 67890,
                   "title": "사기방조",
                   "decision_date": "2020-09-10",
                   "category": "형사",
                   "chunk_summary": "핵심요지: 대포통장·유심 제공의 방조책임 기준 | 근거문장: \"체크카드·유심칩 제공… 범행을 용이하게\" }}
                ]
            }}
            }}
        }},
        "statutes": [
            {{ "code": "형법", "articles": ["347조"] }}
        ],
        "tags": ["사기", "소비자분쟁", "계약분쟁"]
        }}
        
        ### 최종 지침
        * 위 JSON 예시의 구조·키·중괄호·배열 순서를 정확히 유지하십시오.

        ### opinion 필드 작성 규칙 (CRITICAL)
        * 반드시 제공된 판례(case_docs)를 **최소 2건 이상** 구체적으로 인용하여 의견 작성
        * 형식: "○○사건(사건번호: XXXX)에서 법원은 '비슷한 사건의 내용'에 '구체적 판시 내용'이라고 판시한 바, 본 사건 역시 ~한 것으로 예상된다."  
          **두 개 이상을 세미콜론(;) 등으로 연결하여 비교 인용**하라.
        * 판례 인용 없는 일반적 소견은 금지
        * "~하는 것이 예상된다" 또는 "~하는 것이 바람직하다" 등의 추측성 말미 필수

        ### sentencePrediction 필드 작성 규칙 (CRITICAL)
        * 단순한 형량이 아닌 **근거 포함** 예측 작성
        * 형식: "[구체적 근거]로 [예상 결과]가 예상된다."
        * 반드시 "~예측된다", "~것으로 보인다" 등 추측성 표현 사용
        * 한 문장 이내

        ### references.cases 작성 규칙
        * **정확히 3개**(가능하면) 또는 제공 가능한 최대치
        * 각 항목은 id, title, decision_date, category, chunk_summary(위 포맷 엄수)를 포함
        * **중복 금지**, **중요도 순 정렬**
        * **opinion**에서 인용한 2개 이상과 **일치**해야 함

        ### 태그 분류 지침 (CRITICAL - 시스템 무결성 보장)
        - 오직 [태그 목록]의 정확한 문자열만 사용
        - 최대 3개, 중요도 순
        - 금지: "형사", "민사", "행정", "상법", "헌법" 등 목록 외 태그

        ### 법령 참조 지침 (CRITICAL - 법령 정확성 보장)
        - [관련 법령 정보]가 있는 경우에만 사용
        - 불명확하면 articles는 빈 배열로 둘 수 있음
        - statutes는 최소 0개 이상 포함 가능하나, 제공된 경우 반드시 활용
    """
    return PromptTemplate(
        template=template,
        input_variables=[
            "user_query",
            "case_docs",
            "tag_list",
        ],
    )
