from langchain.prompts import PromptTemplate

def get_cot_prompt() -> PromptTemplate:
    """CoT(Chain-of-Thought) 프롬프트를 생성합니다."""
    template = """
        다음 4단계 사고 과정을 따라 사용자 질문에 답변하세요.
        반드시 아래 규칙을 지키십시오.

        ### 규칙
        1. 사고 과정을 내부적으로 수행하되, 출력은 오직 JSON이어야 합니다. (코드블록·주석 금지)
        2. JSON 스키마는 예시와 키·중괄호·배열 순서까지 동일해야 합니다.
        3. 값은 한국어로 작성합니다. (숫자·부호 제외)
        4. 필요 없거나 파악되지 않는 값은 null로 두지 말고 적절히 추론해 채웁니다.
        5. 숫자형 값은 따옴표 없이 기입합니다. (예: 0.84)
        6. issues는 최소 1개 이상, 명사형 문구로 작성합니다.

        ### 사고 과정
        * 사건 무게 판단  
        제공된 판례와 사례를 검토하여 ‘가벼운 사건’인지 ‘무거운 사건’인지 분류하고, 분류 결과에 따라 조언의 강도를 결정하라.

        * 쟁점 파악  
        질문을 분석해 핵심 부분을 요약하고, 주요 법률 쟁점을 명시하라.

        * 사실·법리 분석  
        중요 사실과 적용 법리를 연결하여, 전문가 관점의 논리적 설명을 포함하라.

        * 결론 제시  
        위 분석을 종합해 최종 결론과 근거를 한눈에 제시하라. 전문가 의견을 포함하되, 2~3줄 분량으로 작성하고 “~하는 것이 예상된다” 또는 “~하는 것이 바람직하다” 등의 추측성 표현을 사용하라.
        
        --- 입력 ---
        사용자 질문:
        {user_query}

        관련 판례·법령 정보:
        {case_docs}

        [태그 목록]
        {tag_list}
        --- 입력 끝 ---

        ### 출력 예시 (*구조만 참고, 값은 변경*)
        {{
        "data": {{
            "report": {{
            "issues": ["계약 체결 시 기망 여부", "피해 금액 산정"],
            "opinion": "피해 회복 가능성이 높다는 것이 예상된다.",
            "sentencePrediction": "징역 8월 ~ 1년 6월",
            "confidence": 0.84,
            "references": {{
                "cases": [
                {{ "id": 93810, "title": "소유권이전등기말소", "decision_date": "1978-01-01", "category": "일반 행정", "chunk_summary": "방문판매등에관한법률 제2조 제5호에서 정한 '판매조직에 가입한 판매원의 단계가 3단계 이상'의 의미" }},
                {{ "id": 93810, "title": "소유권이전등기말소", "decision_date": "1978-01-01", "category": "일반 행정", "chunk_summary": "방문판매등에관한법률 제2조 제5호에서 정한 '판매조직에 가입한 판매원의 단계가 3단계 이상'의 의미" }},
                {{ "id": 93810, "title": "소유권이전등기말소", "decision_date": "1978-01-01", "category": "일반 행정", "chunk_summary": "방문판매등에관한법률 제2조 제5호에서 정한 '판매조직에 가입한 판매원의 단계가 3단계 이상'의 의미" }},
                ],
                "statutes": [
                {{ "code": "형법", "article": "347조(사기)" }}
                ]
            }}
            }}
        }},
        "tags": ["사기", "계약분쟁", "소비자보호"]
        }}

        ### 최종 지침
        * 위 JSON 예시의 구조·키·배열 순서를 정확히 유지하십시오.
        * opinion 필드는 2~3줄 분량으로 작성하고, “~하는 것이 예상된다” 또는 “~하는 것이 바람직하다”와 같은 추측성 말미를 사용해야 합니다.
        * sentencePrediction은 간단 명료하게 작성하십시오.
        * cases 배열은 3개의 관련 판례의 ID, 제목, 결정일, 카테고리, 이슈를 포함해야 합니다.
        * title, chunk_summary 판례의 제목과 청크 요약 의미한다. 청크 요약은 해당 청크를 요약한 것으로, 판례의 핵심 내용을 간결하게 설명해야 합니다.
        * 사용자 질문이 법률에 관련 없는 사건의 경우, 대답을 하지 말고 opinion 필드에 "해당 사건은 법률적 분석이 필요하지 않습니다."라고 작성하십시오.

        ### 태그 분류 지침 (CRITICAL - 시스템 무결성 보장)
        
        ⚠️ **중요 경고**: 다음 규칙을 위반하면 시스템이 완전히 실패합니다. 반드시 준수하십시오.
        
        **1. 절대적 태그 제약**
        - 오직 [태그 목록]에 명시된 태그만 사용 가능합니다.
        - 태그 목록에 없는 태그 사용 시 즉시 시스템 오류가 발생합니다.
        - "형사", "민사", "행정", "상법", "헌법" 등은 태그 목록에 없으므로 절대 사용 금지입니다.
        
        **2. 태그 검증 프로세스**
        - 태그를 선택하기 전에 반드시 [태그 목록]에서 정확한 문자열 매칭을 확인하십시오.
        - 유사한 의미라도 정확히 일치하지 않으면 사용할 수 없습니다.
        - 예: "폭행" (X) → "폭력·폭행" (O)
        
        **3. 필수 태그 사용법**
        - 최대 3개의 태그를 중요도 순으로 선택하십시오.
        - 적절한 태그가 없다면 가장 관련성이 높은 태그를 선택하십시오.
        - 태그는 ["태그1", "태그2", "태그3"] 형식의 문자열 배열이어야 합니다.
        
        **4. 금지된 태그 예시**
        - ❌ "형사", "민사", "행정", "상법", "헌법"
        - ❌ "계약", "손해배상", "불법행위" 
        - ✅ "계약분쟁", "사기", "폭력·폭행", "교통사고" 등 목록의 정확한 태그만 사용
        
    """


    return PromptTemplate(
        template=template,
        input_variables=[
            "user_query",
            "case_docs",
            "tag_list",
        ],
    )
