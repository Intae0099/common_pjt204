# ğŸš€ AI ì• í”Œë¦¬ì¼€ì´ì…˜ Windows ë¡œì»¬ ë°°í¬

stages:
  - deploy

variables:
  GIT_STRATEGY: clone
  GIT_DEPTH: 1

# ğŸ“¦ Windows ë¡œì»¬ ìë™ ë°°í¬
deploy:
  stage: deploy
  before_script:
    # AI í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
    - Set-Location ai
    
    # ë¡œì»¬ config/.env íŒŒì¼ì„ ë¹Œë“œ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
    - 'if (Test-Path "F:\S13P11B204\ai\config\.env") { Copy-Item "F:\S13P11B204\ai\config\.env" "config\.env" -Force; Write-Host "âœ… config/.env ë³µì‚¬ ì™„ë£Œ" } else { Write-Host "âŒ ë¡œì»¬ config/.env íŒŒì¼ ì—†ìŒ"; exit 1 }'
    
    # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸
    - 'if (Test-Path "config\.env") { Write-Host "âœ… config/.env íŒŒì¼ ì¡´ì¬" } else { Write-Host "âŒ config/.env íŒŒì¼ ì—†ìŒ"; exit 1 }'
    
  script:
    # 1ï¸âƒ£ í˜„ì¬ ìœ„ì¹˜ í™•ì¸
    - 'Write-Host "í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(Get-Location)"'
    - 'Write-Host "íŒŒì¼ ëª©ë¡:"'
    - Get-ChildItem
    
    # 2ï¸âƒ£ Docker ìƒíƒœ í™•ì¸
    - docker --version
    - docker-compose --version
    
    # 3ï¸âƒ£ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
    - Set-Location docker
    - docker-compose down
    
    # 4ï¸âƒ£ ìƒˆ ë¹Œë“œ ë° ë°°í¬
    - docker-compose up -d --build
    
    # 5ï¸âƒ£ ë°°í¬ í™•ì¸ (AI ëª¨ë¸ ë¡œë”© ì™„ë£Œê¹Œì§€ ëŒ€ê¸°)
    - |
      Write-Host "AI ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
      $maxAttempts = 20
      $attempt = 0
      do {
        $attempt++
        Write-Host "í—¬ìŠ¤ì²´í¬ ì‹œë„ $attempt/$maxAttempts"
        try {
          Invoke-RestMethod -Uri "http://localhost:8997/" -Method Get -TimeoutSec 10
          Write-Host "âœ… AI ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ!"
          break
        } catch {
          Write-Host "ëŒ€ê¸° ì¤‘... (30ì´ˆ í›„ ì¬ì‹œë„)"
          Start-Sleep 30
        }
      } while ($attempt -lt $maxAttempts)
      if ($attempt -eq $maxAttempts) { 
        Write-Host "âŒ AI ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
        exit 1 
      }
    
    # 6ï¸âƒ£ ìƒíƒœ í™•ì¸
    - docker-compose ps
    - docker-compose logs --tail=50 ai-app
    
  only:
    - dev-AI
    - feature/S13P11B204-488
  allow_failure: false